---
title: 在团队中使用GitLab中的Merge Request工作模式
date: 2018-06-01 07:49:45
categories: [技术]
tags: [Git, MergeRequest]
---

在工作中使用`Git`已有5年多的时间了，`Git`分布式的工作机制以及强大的分支功能使得在团队中推广使用没有受到什么阻碍。一直以来都是采用的分支管理模式，我把项目的开发分为三个阶段：开发、测试和上线。

<!--more-->

## 分支管理模式

### 开发阶段

1. 除了`master`分支创建一个供所有开发人员开发的`dev`分支；

2. 开发人员在`dev`分支上进行工作，随时随地`commit`，每天`push`一次到服务器；

3. `push`代码前需要进行`pull`操作，因为有可能在之前有别的成员先进行了`push`操作，如果有冲突还需要进行冲突解决；

4. 每天上班后所有成员对`dev`进行`pull`操作，获取所有成员`push`的代码，有冲突需要解决；

5. 团队Leader每天将`dev`合并一次到`master`。

### 测试阶段

1. 测试进入后就需要添加`test`分支；

2. 在开发人员将代码`push`到`dev`分支后，可以在`dev`基础上创建`test`分支，测试人员以`test`分支搭建测试环境，开始测试；

3. 开发人员在接受到`bug`后，直接在测试分支上修改，然后让测试人员进行验证；

4. 每天团队Leader将测试分支上修改的`bug`合并到`dev`分支上，这样所有团队成员当天修复的`bug`都会在第二天被团队其他人`pull`下来；

5. 团队Leader每天将`dev`合并一次到`master`。

### 上线阶段

1. 系统上线后试运行阶段会存在两种改动：`bug`和优化需求，`bug`通常当天解决晚上部署，优化需求通常周末部署；

2. `bug`当天能修复的就直接在`test`分支上修复，然后进行测试，验证通过后合并到`master`；

3. `bug`当天不能修复的就针对该`bug`创建一个分支，修复完后合并到`test`分支进行测试，验证通过后合并到`master`；

4. 每个优化需求都以`master`分支为基础创建一个`feature`分支，完成后合并到`dev`分支，开发人员可以先交叉测试，然后将`dev`合并到`test`进行测试，验证通过后合并到`master`；

5. `master`始终是一个干净的，可发布的分支。

## Merge Request模式

一直以来，都觉得`Merge Request`模式遥不可及，只有做开源软件才会采用这种模式，没想到这么快就已经在团队中开始推行使用了，先看一张图来了解下`Merge Request`的开发流程：

![-w485](https://cdn.jsdelivr.net/gh/oec2003/hblog-images/img/202201260833619.jpg)

1. 需求或是`Bug`都是用`Issue`来表示；

2. 虽然`Issue`不支持多层级，但结合里程碑、标签等还是可以很好的对任务和`Bug`进行管理；

3. 管理员和团队成员都可以进行`Issue`的创建；

4. 任务的接收者对`Issue`创建`Merge Request`；

5. 完成任务后推送代码到`Merge Request`对应的分支；

6. 管理员对代码进行`Merge`。

**相比较传统的分支管理模式，`Merge Request`可以给我们带来下面几个好处：**

1. 重要分支设置为受保护，杜绝了有些问题代码被提交了，但项目经理不知道的情况；

2. 每个任务都有一个对应的分支，互相隔离，所有的代码改动有据可查；

3. 开发人员不用在分支间切换和合并，更专注于开发。

下面以一个示例来介绍`Merge Request`的工作流程

1、设置重要分支受保护

![-w614](https://cdn.jsdelivr.net/gh/oec2003/hblog-images/img/202201260833102.jpg)

在上图中的位置可以将所有的重要分支设置为受保护，重要的分支通常是`master`、`release`、`test`等。

2、创建`Issue`

![-w616](https://cdn.jsdelivr.net/gh/oec2003/hblog-images/img/202201260834222.jpg)

任务创建后，开发人员就可以对该任务创建`Merge Request`了，如下图：

![-w604](https://cdn.jsdelivr.net/gh/oec2003/hblog-images/img/202201260834936.jpg)

* 创建`Merge Request`时会创建针对这个任务对一个分支；
* 分支名称的格式为：任务编号-[任务标题中出现的英文和数字]，当然分支名称也可以自行修改；
* 分支的Source为该项目设置的主分支，主分支可以在`设置/General/General project settings/Default Branch`进行设置。

3、使用你熟悉的工具拉取`Merge Request`对应的分支到本地进行代码修改，修改完成后，`Push`代码到服务器，代码推送后，管理员在`Merge Request`页面可以看到`Merge`按钮，如下图：

![-w645](https://cdn.jsdelivr.net/gh/oec2003/hblog-images/img/202201260834375.jpg)

点击右边的`Resole WIP status`后，`Merge`按钮就可以使用

![-w625](https://cdn.jsdelivr.net/gh/oec2003/hblog-images/img/202201260834501.jpg)

如果勾选`Remove source brance`，当`Merge`后，服务器端会删除创建的分支。`Merge`完成，会关闭关联的任务，但并不是每一次推送都可以非常顺利，有时会有冲突，当本地代码和服务器代码不一致时，会出现解决冲突的按钮，解决冲突后才能进行`Merge`

![-w636](https://cdn.jsdelivr.net/gh/oec2003/hblog-images/img/202201260835126.jpg)

代码`Merge`后，开发人员就可以按照同样的流程做下一个任务了。

## 思考

* 如果系统上线后有紧急`Bug`需要处理，这个流程应该怎样去调整？
* 每个任务都在单独分支并行开发，这是如果A和B都以来C开发的一个模块，应该怎么解决？
* 理论上`Issue`管理员和开发人员都可以进行创建，什么样的`Issue`可以有开发人员来创建？

## 总结

* 任何一种模式或工作方式的改变，总会打破一些人的舒适区，我们应该学会走出舒适区，拥抱变化；
* 尝试新的东西肯定会遇到各种问题，先执行，然后再持续优化改进，逐步达到最优状态；
* 从团队试用的情况来看，暂时没有出现水土不服的情况。

